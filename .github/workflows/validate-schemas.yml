name: Validate JSON files against schemas

on:
  push:
    branches: [ 'dev', 'main' ]
  pull_request:
    types: [opened, synchronize, reopened]
    # run for PRs targeting main (job will early-exit for other PRs)

jobs:
  validate-schemas:
    name: Validate schemas
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main' && (github.event.pull_request.head.ref == 'dev' || startsWith(github.event.pull_request.head.ref, 'dev')))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install jsonschema
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate JSON/GeoJSON files against schemas
        # The script walks the repository and validates each .json/.geojson file
        # - If file is inside maps/LF* subfolder it uses .github/schema/map.schema.json
        # - Otherwise it tries .github/schema/<basename>.schema.json
        # - CoFrance.toml is ignored
        run: |
          python - <<'PY'
          import os, sys, json, re
          from jsonschema import Draft7Validator

          repo_root = os.getcwd()
          schema_dir = os.path.join(repo_root, '.github', 'schema')

          def is_lf_subfolder(path):
              # path is relative path with forward slashes on linux runner
              parts = path.split(os.sep)
              # expect maps/<folder>/...
              return len(parts) >= 2 and parts[0] == 'maps' and re.match(r'^LF[A-Z0-9]+$', parts[1])

          errors = []
          validated = 0
          for root, dirs, files in os.walk(repo_root):
              # skip .git
              if '.git' in root:
                  continue
              # skip schema folder itself
              if os.path.commonpath([os.path.abspath(root), os.path.abspath(schema_dir)]) == os.path.abspath(schema_dir):
                  continue
              for fname in files:
                  relpath = os.path.relpath(os.path.join(root, fname), repo_root)
                  # normalize
                  relposix = relpath.replace('\\', '/')

                  # ignore CoFrance.toml explicitly
                  if os.path.normpath(relpath) == 'CoFrance.toml':
                      continue

                  if not (fname.endswith('.json') or fname.endswith('.geojson')):
                      continue

                  # Determine schema path
                  if is_lf_subfolder(relpath):
                      schema_path = os.path.join(schema_dir, 'map.schema.json')
                  else:
                      schema_candidate = os.path.join(schema_dir, fname + '.schema.json')
                      # support schema names like tag_formats.schema.json for tag_formats.json
                      alt = os.path.join(schema_dir, os.path.splitext(fname)[0] + '.schema.json')
                      if os.path.exists(schema_candidate):
                          schema_path = schema_candidate
                      elif os.path.exists(alt):
                          schema_path = alt
                      else:
                          # also allow matching by removing extensions like .geojson -> .schema.json
                          schema_path = None

                  if not schema_path or not os.path.exists(schema_path):
                      errors.append(f"No schema found for '{relposix}'. Expected schema at '.github/schema/{os.path.basename(fname)}.schema.json' or for LF* maps use 'map.schema.json'.")
                      continue

                  # load schema and instance
                  try:
                      with open(schema_path, 'r', encoding='utf-8') as sf:
                          schema = json.load(sf)
                  except Exception as e:
                      errors.append(f"Failed to load schema '{os.path.relpath(schema_path, repo_root)}': {e}")
                      continue

                  try:
                      with open(os.path.join(root, fname), 'r', encoding='utf-8') as df:
                          instance = json.load(df)
                  except Exception as e:
                      errors.append(f"Failed to parse JSON '{relposix}': {e}")
                      continue

                  validator = Draft7Validator(schema)
                  issues = sorted(validator.iter_errors(instance), key=lambda e: (list(e.path), e.message))
                  if issues:
                      errors.append(f"Validation errors for '{relposix}' against schema '{os.path.relpath(schema_path, repo_root)}':")
                      for err in issues:
                          path = '/'.join(map(str, err.absolute_path)) if err.absolute_path else '(root)'
                          errors.append(f" - {path}: {err.message}")
                  else:
                      validated += 1

          if errors:
              print('\n'.join(errors))
              print(f"\nValidation failed: {len(errors)} problem(s). Files validated successfully: {validated}")
              sys.exit(1)
          else:
              print(f"All validated files OK. Files validated: {validated}")
          PY
